#!/usr/bin/env sh
set -e

echo "üîç Running pre-push validation (same as CI)..."

# Source nvm if it exists
if [ -f "$HOME/.nvm/nvm.sh" ]; then
    . "$HOME/.nvm/nvm.sh"
fi

# Add common Windows Node.js paths
export PATH="$PATH:/c/Program Files/nodejs:/c/Program Files (x86)/nodejs"
export PATH="$PATH:$APPDATA/npm:$HOME/AppData/Roaming/npm"

# Run CI checks
if command -v npm >/dev/null 2>&1; then
    echo "‚úì Running typecheck..."
    npm run typecheck || exit 1
    
    echo "‚úì Running lint..."
    npm run lint || exit 1
    
    # Running the full test-suite here causes intermittent worker IPC failures
    # on some Windows/Node environments which block pushes. CI still runs tests.
    # To avoid developer friction, only run typecheck + lint locally by default.
    if [ "$CI" = "true" ] || [ "$RUN_PRE_PUSH_TESTS" = "1" ]; then
        echo "‚úì Running tests (Vitest single worker via script)..."
        node ./scripts/run-tests-single.js || exit 1
    else
        echo "‚ö†Ô∏è  Skipping tests in pre-push hook (run locally with RUN_PRE_PUSH_TESTS=1)"
        echo "   CI will run the full test-suite. To run tests locally:"
        echo "     RUN_PRE_PUSH_TESTS=1 node ./scripts/run-tests-single.js"
    fi
    
    echo "‚úÖ All pre-push checks passed!"
else
    echo "‚ö†Ô∏è  WARNING: npm not found. Skipping pre-push checks."
    echo "   Run manually: npm run ci"
fi
